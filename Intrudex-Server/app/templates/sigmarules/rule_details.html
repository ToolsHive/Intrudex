{% extends "base.html" %}
{% block title %}{% if rule %}{{ rule.title }}{% else %}Rule Details{% endif %}{% endblock %}

{% block styles %}
<style>
/* Skeleton loading animation */
.skeleton {
  animation: skeleton-loading 1.2s infinite ease-in-out;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.05) 25%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.05) 75%);
  background-size: 200% 100%;
  border-radius: 4px;
}

@keyframes skeleton-loading {
  0% {
    background-position: 200% 0;
  }
  100% {
    background-position: -200% 0;
  }
}

/* Loading progress bar */
.progress-bar-container {
  width: 100%;
  height: 6px;
  background-color: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 8px;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #4f46e5, #8b5cf6);
  width: 0%;
  transition: width 0.3s ease-in-out;
}

/* Hidden content */
.hidden {
  display: none;
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Back Button -->
    <div class="mb-6">
      <a href="{{ url_for('sigmarules.run_rules') }}" 
         class="inline-flex items-center px-4 py-2 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-lg text-white transition-all duration-300 hover:scale-105">
        <i class="fas fa-arrow-left mr-2"></i> Back to Rules
      </a>
    </div>

    <!-- Hidden input with rule ID for JavaScript -->
    <input type="hidden" id="rule-id" value="{{ rule.id if rule else '' }}">


    <!-- Skeleton Loader for Rule Details -->
    <div id="rule-details-skeleton" class="bg-gradient-to-r from-gray-900/80 to-gray-800/80 backdrop-blur-sm rounded-xl p-8 mb-8 border border-white/10 {% if not loading %}hidden{% endif %}">
      <div class="flex flex-col gap-8">
        <!-- Header Skeleton -->
        <div class="flex items-center gap-4 mb-6">
          <div class="h-10 w-10 bg-gray-700 rounded-full skeleton"></div>
          <div class="h-8 w-2/3 bg-gray-700 rounded skeleton"></div>
        </div>
        <div class="h-6 w-1/2 bg-gray-700 rounded skeleton mb-4"></div>
        <div class="flex gap-3 mb-6">
          <div class="h-8 w-32 bg-gray-700 rounded-full skeleton"></div>
          <div class="h-8 w-32 bg-gray-700 rounded-full skeleton"></div>
          <div class="h-8 w-32 bg-gray-700 rounded-full skeleton"></div>
        </div>
        <!-- Stats Skeleton -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          {% for _ in range(4) %}
          <div class="bg-gray-800/80 rounded-xl p-6 border border-gray-700/30 animate-pulse">
            <div class="h-4 w-24 bg-gray-700 rounded mb-2"></div>
            <div class="h-8 w-16 bg-gray-700 rounded mb-2"></div>
            <div class="h-2 w-full bg-gray-700 rounded"></div>
          </div>
          {% endfor %}
        </div>
        <!-- MITRE Techniques Skeleton -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {% for _ in range(2) %}
          <div class="bg-gray-800/60 rounded-xl p-6 border border-gray-700/50 animate-pulse">
            <div class="h-4 w-32 bg-gray-700 rounded mb-2"></div>
            <div class="h-3 w-48 bg-gray-700 rounded mb-2"></div>
            <div class="h-2 w-full bg-gray-700 rounded mb-2"></div>
            <div class="flex gap-2 mb-2">
              <div class="h-4 w-12 bg-gray-700 rounded"></div>
              <div class="h-4 w-8 bg-gray-700 rounded"></div>
            </div>
            <div class="h-3 w-24 bg-gray-700 rounded"></div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Error Container (Hidden by default) -->
    <div id="error-container" class="bg-red-500/20 border border-red-500/50 rounded-xl p-8 backdrop-blur-sm hidden">
      <div class="text-center">
        <i class="fas fa-exclamation-triangle text-red-400 text-6xl mb-4"></i>
        <h2 class="text-red-200 font-bold text-2xl mb-2">Error Loading Rule</h2>
        <p class="text-red-300">There was a problem loading the rule details. Please try again later.</p>
        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-red-500/30 hover:bg-red-500/50 text-white rounded-lg">
          <i class="fas fa-sync-alt mr-2"></i>Retry
        </button>
      </div>
    </div>

    {% if error %}
      <div class="bg-red-500/20 border border-red-500/50 rounded-xl p-8 backdrop-blur-sm">
        <div class="text-center">
          <i class="fas fa-exclamation-triangle text-red-400 text-6xl mb-4"></i>
          <h2 class="text-red-200 font-bold text-2xl mb-2">Error Loading Rule</h2>
          <p class="text-red-300">{{ error }}</p>
        </div>
      </div>
    {% elif rule %}
      <!-- Skeleton loader is hidden when rule is loaded -->
      <div id="rule-details-content">
        <!-- ...existing code... -->
      </div>

      <!-- Statistics Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Quality Score -->
        <div class="bg-gradient-to-br from-blue-500/20 to-purple-600/20 backdrop-blur-sm rounded-xl p-6 border border-white/10 hover:scale-105 transition-all duration-300">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-white font-semibold">Quality Score</h3>
            <i class="fas fa-medal text-yellow-400 text-xl"></i>
          </div>
          <div class="text-3xl font-bold text-white mb-2">{{ rule.quality_score }}%</div>
          <div class="w-full bg-gray-700 rounded-full h-2">
            <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-1000" 
                 style="width: {{ rule.quality_score }}%"></div>
          </div>
        </div>

        <!-- MITRE Techniques -->
        <div class="bg-gradient-to-br from-red-500/20 to-pink-600/20 backdrop-blur-sm rounded-xl p-6 border border-white/10 hover:scale-105 transition-all duration-300 shadow-lg">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-white font-semibold">MITRE Techniques</h3>
            <i class="fas fa-crosshairs text-red-400 text-xl"></i>
          </div>
          <div class="text-3xl font-bold text-white mb-2">{{ rule.stats.mitre_technique_count if rule.stats else (rule.mitre_attack|length if rule.mitre_attack else 0) }}</div>
          <div class="text-gray-400 text-sm mb-3">ATT&CK Coverage</div>
          <div class="w-full bg-gray-700 rounded-full h-2">
            <div class="bg-gradient-to-r from-red-500 to-pink-500 h-2 rounded-full transition-all duration-1000" 
                 style="width: {{ ((rule.stats.mitre_technique_count if rule.stats else 0) * 20)|int }}%"></div>
          </div>
        </div>

        <!-- Detection Fields -->
        <div class="bg-gradient-to-br from-orange-500/20 to-yellow-600/20 backdrop-blur-sm rounded-xl p-6 border border-white/10 hover:scale-105 transition-all duration-300 shadow-lg">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-white font-semibold">Detection Fields</h3>
            <i class="fas fa-search text-orange-400 text-xl"></i>
          </div>
          <div class="text-3xl font-bold text-white mb-2">{{ rule.stats.total_fields if rule.stats else 'N/A' }}</div>
          <div class="text-gray-400 text-sm mb-3">{{ rule.detection_complexity }} Logic</div>
          <div class="flex space-x-2 text-xs">
            {% if rule.stats and rule.stats.uses_regex %}
            <span class="px-2 py-1 bg-blue-600/30 text-blue-200 rounded">RegEx</span>
            {% endif %}
            {% if rule.stats and rule.stats.has_filters %}
            <span class="px-2 py-1 bg-green-600/30 text-green-200 rounded">Filters</span>
            {% endif %}
            {% if rule.stats and rule.stats.uses_wildcards %}
            <span class="px-2 py-1 bg-purple-600/30 text-purple-200 rounded">Wildcards</span>
            {% endif %}
          </div>
        </div>

        <!-- Recent Matches -->
        <div class="bg-gradient-to-br from-green-500/20 to-emerald-600/20 backdrop-blur-sm rounded-xl p-6 border border-white/10 hover:scale-105 transition-all duration-300 shadow-lg">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-white font-semibold">Recent Matches</h3>
            <i class="fas fa-exclamation-triangle text-green-400 text-xl"></i>
          </div>
          <div class="text-3xl font-bold text-white mb-2">{{ rule.stats.recent_matches if rule.stats else (recent_matches|length if recent_matches else 0) }}</div>
          <div class="text-gray-400 text-sm mb-3">Last 24 Hours</div>
          <div class="w-full bg-gray-700 rounded-full h-2">
            <div class="bg-gradient-to-r from-green-500 to-emerald-500 h-2 rounded-full transition-all duration-1000" 
                 style="width: {{ ((rule.stats.recent_matches if rule.stats else 0) * 2)|int }}%"></div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-8">
          <!-- Enhanced MITRE ATT&CK Section -->
          {% if rule.mitre_attack %}
          <div class="bg-gradient-to-br from-red-500/10 to-pink-600/10 backdrop-blur-sm rounded-xl border border-red-500/20 overflow-hidden shadow-2xl">
            <div class="bg-gradient-to-r from-red-600 to-pink-600 p-6">
              <div class="flex items-center justify-between">
                <h2 class="text-white font-bold text-2xl flex items-center">
                  <i class="fas fa-crosshairs mr-3 text-white"></i>MITRE ATT&CK Intelligence
                </h2>
                <div class="flex items-center space-x-4">
                  <div class="text-white/90 text-sm bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm">
                    {{ rule.mitre_attack|length }} technique(s)
                  </div>
                  <a href="https://attack.mitre.org/" target="_blank" rel="noopener" class="text-white/80 hover:text-white transition-colors">
                    <i class="fas fa-external-link-alt text-sm"></i>
                  </a>
                </div>
              </div>
            </div>
            
            <div class="p-6">
              <!-- Enhanced Information Banner -->
              <div class="mb-6 p-5 bg-gradient-to-r from-red-500/5 to-pink-500/5 border border-red-500/20 rounded-xl">
                <div class="flex items-start">
                  <div class="w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center mr-4 flex-shrink-0">
                    <i class="fas fa-shield-alt text-red-400 text-xl"></i>
                  </div>
                  <div class="text-red-200">
                    <p class="font-semibold mb-2 text-lg">MITRE ATT&CK Framework Integration</p>
                    <p class="text-sm leading-relaxed">This rule maps to specific adversary techniques documented in the MITRE ATT&CK knowledge base. Each technique includes risk assessment, detection difficulty, and prevalence data sourced from official MITRE repositories and threat intelligence.</p>
                  </div>
                </div>
              </div>
              
              <!-- Enhanced Technique Cards -->
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {% for technique in rule.mitre_attack %}
                <div class="group relative">
                  <div class="absolute inset-0 bg-gradient-to-r from-red-500/20 to-pink-500/20 rounded-xl blur opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                  <div class="relative bg-gradient-to-br from-red-500/10 to-pink-500/10 backdrop-blur-sm rounded-xl p-6 border border-red-400/30 hover:border-red-400/60 transition-all duration-300 hover:scale-[1.02] hover:shadow-2xl">
                    <!-- Technique Header -->
                    <div class="flex items-center justify-between mb-4">
                      <div class="flex items-center space-x-3">
                        <span class="px-3 py-1 bg-red-600/30 text-red-200 font-mono text-sm font-bold rounded-full border border-red-500/30">
                          {{ technique.technique_id or 'Unknown ID' }}
                        </span>
                        {% if technique.is_subtechnique %}
                        <span class="px-2 py-1 bg-orange-600/30 text-orange-200 text-xs rounded-full border border-orange-500/30">
                          Sub-technique
                        </span>
                        {% endif %}
                      </div>
                      <a href="{{ technique.url or ('https://attack.mitre.org/techniques/' + technique.technique_id + '/') }}" 
                         target="_blank" rel="noopener" 
                         class="text-red-400 hover:text-red-300 transition-colors p-2 hover:bg-red-500/10 rounded-full">
                        <i class="fas fa-external-link-alt text-sm"></i>
                      </a>
                    </div>

                    <!-- Technique Name and Description -->
                    <h3 class="text-white font-bold text-lg mb-3 leading-tight">
                      {{ technique.name or technique.display_name or 'Unknown Technique' }}
                    </h3>
                    
                    <p class="text-gray-300 text-sm mb-4 leading-relaxed line-clamp-3">
                      {{ technique.description or 'Advanced adversary technique used in cyber attacks. This technique represents documented tactics, techniques, and procedures (TTPs) observed in real-world operations.' }}
                    </p>

                    <!-- Risk and Difficulty Indicators -->
                    <div class="grid grid-cols-3 gap-3 mb-4">
                      <!-- Risk Level -->
                      <div class="text-center">
                        <div class="w-full bg-gray-700/50 rounded-full h-2 mb-2">
                          <div class="h-2 rounded-full transition-all duration-1000
                            {% if technique.risk_level == 'critical' %}bg-gradient-to-r from-red-600 to-red-700
                            {% elif technique.risk_level == 'high' %}bg-gradient-to-r from-orange-500 to-red-500
                            {% elif technique.risk_level == 'medium' %}bg-gradient-to-r from-yellow-500 to-orange-500
                            {% else %}bg-gradient-to-r from-blue-500 to-cyan-500{% endif %}"
                               style="width: {% if technique.risk_level == 'critical' %}100{% elif technique.risk_level == 'high' %}75{% elif technique.risk_level == 'medium' %}50{% else %}25{% endif %}%"></div>
                        </div>
                        <p class="text-xs text-gray-400">Risk</p>
                        <p class="text-xs font-semibold
                          {% if technique.risk_level == 'critical' %}text-red-400
                          {% elif technique.risk_level == 'high' %}text-orange-400
                          {% elif technique.risk_level == 'medium' %}text-yellow-400
                          {% else %}text-blue-400{% endif %}">
                          {{ technique.risk_level|title if technique.risk_level else 'Medium' }}
                        </p>
                      </div>

                      <!-- Prevalence -->
                      <div class="text-center">
                        <div class="w-full bg-gray-700/50 rounded-full h-2 mb-2">
                          <div class="h-2 rounded-full transition-all duration-1000
                            {% if technique.prevalence == 'high' %}bg-gradient-to-r from-red-500 to-pink-500
                            {% elif technique.prevalence == 'medium' %}bg-gradient-to-r from-yellow-500 to-orange-500
                            {% else %}bg-gradient-to-r from-green-500 to-emerald-500{% endif %}"
                               style="width: {% if technique.prevalence == 'high' %}90{% elif technique.prevalence == 'medium' %}60{% else %}30{% endif %}%"></div>
                        </div>
                        <p class="text-xs text-gray-400">Prevalence</p>
                        <p class="text-xs font-semibold
                          {% if technique.prevalence == 'high' %}text-red-400
                          {% elif technique.prevalence == 'medium' %}text-yellow-400
                          {% else %}text-green-400{% endif %}">
                          {{ technique.prevalence|title if technique.prevalence else 'Low' }}
                        </p>
                      </div>

                      <!-- Detection Difficulty -->
                      <div class="text-center">
                        <div class="w-full bg-gray-700/50 rounded-full h-2 mb-2">
                          <div class="h-2 rounded-full transition-all duration-1000
                            {% if technique.difficulty == 'hard' %}bg-gradient-to-r from-red-500 to-pink-500
                            {% elif technique.difficulty == 'medium' %}bg-gradient-to-r from-yellow-500 to-orange-500
                            {% else %}bg-gradient-to-r from-green-500 to-emerald-500{% endif %}"
                               style="width: {% if technique.difficulty == 'hard' %}85{% elif technique.difficulty == 'medium' %}55{% else %}25{% endif %}%"></div>
                        </div>
                        <p class="text-xs text-gray-400">Detection</p>
                        <p class="text-xs font-semibold
                          {% if technique.difficulty == 'hard' %}text-red-400
                          {% elif technique.difficulty == 'medium' %}text-yellow-400
                          {% else %}text-green-400{% endif %}">
                          {{ technique.difficulty|title if technique.difficulty else 'Easy' }}
                        </p>
                      </div>
                    </div>

                    <!-- Platforms and Tactics -->
                    <div class="space-y-3">
                      {% if technique.platforms %}
                      <div>
                        <p class="text-gray-400 text-xs font-semibold mb-2">PLATFORMS</p>
                        <div class="flex flex-wrap gap-1">
                          {% for platform in technique.platforms[:4] %}
                          <span class="px-2 py-1 bg-blue-600/20 text-blue-200 text-xs rounded border border-blue-500/30">
                            {{ platform }}
                          </span>
                          {% endfor %}
                          {% if technique.platforms|length > 4 %}
                          <span class="px-2 py-1 bg-gray-600/20 text-gray-300 text-xs rounded border border-gray-500/30">
                            +{{ technique.platforms|length - 4 }} more
                          </span>
                          {% endif %}
                        </div>
                      </div>
                      {% endif %}

                      {% if technique.tactics %}
                      <div>
                        <p class="text-gray-400 text-xs font-semibold mb-2">TACTICS</p>
                        <div class="flex flex-wrap gap-1">
                          {% for tactic in technique.tactics[:3] %}
                          <span class="px-2 py-1 bg-purple-600/20 text-purple-200 text-xs rounded border border-purple-500/30">
                            {{ tactic|replace('_', ' ')|title }}
                          </span>
                          {% endfor %}
                          {% if technique.tactics|length > 3 %}
                          <span class="px-2 py-1 bg-gray-600/20 text-gray-300 text-xs rounded border border-gray-500/30">
                            +{{ technique.tactics|length - 3 }} more
                          </span>
                          {% endif %}
                        </div>
                      </div>
                      {% endif %}

                      {% if technique.data_sources %}
                      <div>
                        <p class="text-gray-400 text-xs font-semibold mb-2">DATA SOURCES</p>
                        <div class="flex flex-wrap gap-1">
                          {% for source in technique.data_sources[:3] %}
                          <span class="px-2 py-1 bg-emerald-600/20 text-emerald-200 text-xs rounded border border-emerald-500/30">
                            {{ source|truncate(15) }}
                          </span>
                          {% endfor %}
                          {% if technique.data_sources|length > 3 %}
                          <span class="px-2 py-1 bg-gray-600/20 text-gray-300 text-xs rounded border border-gray-500/30">
                            +{{ technique.data_sources|length - 3 }} more
                          </span>
                          {% endif %}
                        </div>
                      </div>
                      {% endif %}
                    </div>

                    <!-- Detection Guidance -->
                    {% if technique.detection and technique.detection != 'No detection information available' %}
                    <div class="mt-4 p-3 bg-gray-800/30 rounded-lg border border-gray-700/50">
                      <p class="text-gray-400 text-xs font-semibold mb-2 flex items-center">
                        <i class="fas fa-search mr-1"></i>DETECTION GUIDANCE
                      </p>
                      <p class="text-gray-300 text-xs leading-relaxed">
                        {{ technique.detection|truncate(200) }}
                      </p>
                    </div>
                    {% endif %}

                    <!-- Action Buttons -->
                    <div class="mt-4 flex items-center justify-between">
                      <a href="{{ technique.url or ('https://attack.mitre.org/techniques/' + technique.technique_id + '/') }}" 
                         target="_blank" rel="noopener" 
                         class="text-red-300 hover:text-red-200 text-xs font-semibold transition-colors flex items-center">
                        <i class="fas fa-book mr-1"></i>View Documentation
                      </a>
                      <button onclick="copyTechniqueInfo('{{ technique.technique_id }}', '{{ technique.name }}')" 
                              class="text-gray-400 hover:text-gray-300 text-xs transition-colors" title="Copy Technique Info">
                        <i class="fas fa-copy"></i>
                      </button>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>

              <!-- MITRE ATT&CK Summary -->
              <div class="mt-6 p-4 bg-gradient-to-r from-red-500/5 to-pink-500/5 border border-red-500/20 rounded-lg">
                <div class="flex items-center justify-between text-sm">
                  <div class="text-red-200">
                    <span class="font-semibold">Coverage Analysis:</span> This rule provides detection for {{ rule.mitre_attack|length }} documented adversary technique(s)
                  </div>
                  <a href="https://attack.mitre.org/" target="_blank" rel="noopener" class="text-red-400 hover:text-red-300 transition-colors">
                    Learn more about MITRE ATT&CK
                    <i class="fas fa-external-link-alt ml-1"></i>
                  </a>
                </div>
              </div>
            </div>
          </div>
          {% else %}
          <!-- No MITRE Techniques -->
          <div class="bg-gradient-to-br from-gray-500/10 to-gray-600/10 backdrop-blur-sm rounded-xl border border-gray-500/20 p-8 text-center">
            <i class="fas fa-crosshairs text-gray-400 text-4xl mb-4"></i>
            <h3 class="text-white font-semibold text-lg mb-2">No MITRE ATT&CK Mapping</h3>
            <p class="text-gray-400 text-sm">This rule is not currently mapped to specific MITRE ATT&CK techniques. Consider adding relevant technique tags to improve threat intelligence context.</p>
          </div>
          {% endif %}

          <!-- Detection Logic -->
          <div class="bg-gradient-to-br from-blue-500/10 to-purple-600/10 backdrop-blur-sm rounded-xl border border-blue-500/20 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4">
              <div class="flex items-center justify-between">
                <h2 class="text-white font-bold text-xl flex items-center">
                  <i class="fas fa-code mr-3"></i>Detection Logic
                </h2>
                <button onclick="copyDetectionCode()" 
                        class="px-3 py-1 bg-white/20 hover:bg-white/30 rounded-lg text-white text-sm transition-all duration-300" title="Copy Detection Logic">
                  <i class="fas fa-copy mr-1"></i>Copy
                </button>
              </div>
            </div>
            <div class="px-6 pt-4">
              <div class="bg-blue-500/5 border border-blue-500/20 rounded-lg p-4 mb-4">
                <div class="flex items-start">
                  <i class="fas fa-lightbulb text-blue-400 mr-3 mt-0.5"></i>
                  <div class="text-blue-200 text-sm">
                    <p class="font-semibold mb-1">How This Detection Works</p>
                    <p>This Sigma rule defines specific patterns and conditions that security tools should monitor for. The detection logic below shows the exact criteria used to identify potential threats.</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="p-0">
              <pre id="detection-code" class="bg-gray-900 text-gray-100 p-6 overflow-x-auto text-sm font-mono leading-relaxed border-t border-blue-500/20"><code>{{ rule.detection_pretty }}</code></pre>
            </div>
            <!-- Detection Components Breakdown -->
            {% if rule.detection %}
            <div class="px-6 pb-6">
              <div class="bg-purple-500/5 border border-purple-500/20 rounded-lg p-4">
                <h4 class="text-white font-semibold mb-3 flex items-center">
                  <i class="fas fa-puzzle-piece mr-2"></i>Detection Components
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <span class="text-purple-300 text-sm font-medium">Detection Fields:</span>
                    <span class="text-white ml-2">{{ rule.detection.keys()|list|length if rule.detection else 0 }}</span>
                  </div>
                  <div>
                    <span class="text-purple-300 text-sm font-medium">Complexity:</span>
                    <span class="text-white ml-2">{{ rule.detection_complexity or 'Not specified' }}</span>
                  </div>
                  {% if rule.detection and rule.detection.get('condition') %}
                  <div class="md:col-span-2">
                    <span class="text-purple-300 text-sm font-medium">Condition:</span>
                    <code class="text-purple-100 ml-2 text-xs bg-purple-900/30 px-2 py-1 rounded">{{ rule.detection.condition }}</code>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endif %}
          </div>

          <!-- Quality Factors -->
          {% if rule.quality_factors %}
          <div class="bg-gradient-to-br from-green-500/10 to-emerald-600/10 backdrop-blur-sm rounded-xl border border-green-500/20 overflow-hidden">
            <div class="bg-gradient-to-r from-green-600 to-emerald-600 p-4">
              <h2 class="text-white font-bold text-xl flex items-center">
                <i class="fas fa-check-circle mr-3"></i>Quality Indicators
              </h2>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                {% for factor in rule.quality_factors %}
                <div class="flex items-center text-green-300">
                  <i class="fas fa-check-circle mr-3 text-green-400"></i>
                  <span>{{ factor }}</span>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endif %}

          <!-- False Positives -->
          {% if rule.falsepositives %}
          <div class="bg-gradient-to-br from-yellow-500/10 to-orange-600/10 backdrop-blur-sm rounded-xl border border-yellow-500/20 overflow-hidden">
            <div class="bg-gradient-to-r from-yellow-600 to-orange-600 p-4">
              <h2 class="text-white font-bold text-xl flex items-center">
                <i class="fas fa-exclamation-triangle mr-3"></i>False Positives
              </h2>
            </div>
            <div class="p-6 space-y-3">
              {% for fp in rule.falsepositives %}
              <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                <div class="flex items-start">
                  <i class="fas fa-info-circle text-yellow-400 mr-3 mt-0.5"></i>
                  <span class="text-yellow-200">{{ fp }}</span>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- References -->
          {% if rule.references %}
          <div class="bg-gradient-to-br from-cyan-500/10 to-blue-600/10 backdrop-blur-sm rounded-xl border border-cyan-500/20 overflow-hidden">
            <div class="bg-gradient-to-r from-cyan-600 to-blue-600 p-4">
              <h2 class="text-white font-bold text-xl flex items-center">
                <i class="fas fa-link mr-3"></i>References
              </h2>
            </div>
            <div class="p-6 space-y-3">
              {% for ref in rule.references %}
              <div class="group">
                {% if ref.startswith('http') %}
                <a href="{{ ref }}" target="_blank" rel="noopener"
                   class="flex items-center p-3 bg-cyan-500/10 hover:bg-cyan-500/20 border border-cyan-500/30 hover:border-cyan-400/50 rounded-lg transition-all duration-300">
                  <i class="fas fa-external-link-alt text-cyan-400 mr-3"></i>
                  <span class="text-cyan-200 group-hover:text-cyan-100 break-all">{{ ref }}</span>
                </a>
                {% else %}
                <div class="flex items-center p-3 bg-cyan-500/10 border border-cyan-500/30 rounded-lg">
                  <i class="fas fa-file-alt text-cyan-400 mr-3"></i>
                  <span class="text-cyan-200">{{ ref }}</span>
                </div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <!-- Rule Metadata -->
          <div class="bg-gradient-to-br from-gray-500/10 to-gray-600/10 backdrop-blur-sm rounded-xl border border-gray-500/20 overflow-hidden">
            <div class="bg-gradient-to-r from-gray-600 to-gray-700 p-4">
              <h3 class="text-white font-bold text-lg flex items-center">
                <i class="fas fa-info-circle mr-3"></i>Rule Metadata
              </h3>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-gray-400 text-sm font-medium">Rule ID</label>
                <div class="text-white font-mono text-sm bg-gray-800/50 p-2 rounded mt-1">{{ rule.id }}</div>
              </div>
              {% if rule.author and rule.author != 'Not specified' %}
              <div>
                <label class="text-gray-400 text-sm font-medium">Author</label>
                <div class="text-white">{{ rule.author }}</div>
              </div>
              {% endif %}
              {% if rule.date and rule.date != 'Not specified' %}
              <div>
                <label class="text-gray-400 text-sm font-medium">Created</label>
                <div class="text-white">{{ rule.date }}</div>
              </div>
              {% endif %}
              {% if rule.modified and rule.modified != 'Not specified' %}
              <div>
                <label class="text-gray-400 text-sm font-medium">Modified</label>
                <div class="text-white">{{ rule.modified }}</div>
              </div>
              {% endif %}
              {% if rule.status and rule.status != 'Not specified' %}
              <div>
                <label class="text-gray-400 text-sm font-medium">Status</label>
                <span class="px-2 py-1 bg-green-500/20 text-green-300 rounded-full text-sm">{{ rule.status|title }}</span>
              </div>
              {% endif %}
              {% if rule.license and rule.license != 'Not specified' %}
              <div>
                <label class="text-gray-400 text-sm font-medium">License</label>
                <span class="px-2 py-1 bg-blue-500/20 text-blue-300 rounded-full text-sm">{{ rule.license }}</span>
              </div>
              {% endif %}
              {% if rule.category and rule.category != 'Not specified' %}
              <div>
                <label class="text-gray-400 text-sm font-medium">Category</label>
                <div class="text-white">{{ rule.category }}</div>
              </div>
              {% endif %}
              {% if rule.product and rule.product != 'Not specified' %}
              <div>
                <label class="text-gray-400 text-sm font-medium">Product</label>
                <div class="text-white">{{ rule.product }}</div>
              </div>
              {% endif %}
              {% if rule.service and rule.service != 'Not specified' %}
              <div>
                <label class="text-gray-400 text-sm font-medium">Service</label>
                <div class="text-white">{{ rule.service }}</div>
              </div>
              {% endif %}
              {% if rule.filename and rule.filename != 'Not specified' %}
              <div>
                <label class="text-gray-400 text-sm font-medium">Filename</label>
                <div class="text-white font-mono text-sm bg-gray-800/50 p-2 rounded mt-1">{{ rule.filename }}</div>
              </div>
              {% endif %}
              {% if rule.file_path and rule.file_path != 'Not specified' %}
              <div>
                <label class="text-gray-400 text-sm font-medium">File Path</label>
                <div class="text-white font-mono text-sm bg-gray-800/50 p-2 rounded mt-1">{{ rule.file_path }}</div>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Log Source -->
          {% if rule.logsource %}
          <div class="bg-gradient-to-br from-indigo-500/10 to-purple-600/10 backdrop-blur-sm rounded-xl border border-indigo-500/20 overflow-hidden">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-4">
              <h3 class="text-white font-bold text-lg flex items-center">
                <i class="fas fa-database mr-3"></i>Log Source
              </h3>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="text-gray-400 text-sm font-medium">Category</label>
                <div class="text-white">{{ rule.category }}</div>
              </div>
              <div>
                <label class="text-gray-400 text-sm font-medium">Product</label>
                <div class="text-white">{{ rule.product }}</div>
              </div>
              <div>
                <label class="text-gray-400 text-sm font-medium">Service</label>
                <div class="text-white">{{ rule.service }}</div>
              </div>
              
              {% if rule.platforms %}
              <div>
                <label class="text-gray-400 text-sm font-medium">Platforms</label>
                <div class="flex flex-wrap gap-2 mt-2">
                  {% for platform in rule.platforms %}
                  <span class="px-2 py-1 bg-blue-500/20 text-blue-300 rounded-full text-sm">{{ platform }}</span>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
              
              {% if rule.data_sources %}
              <div>
                <label class="text-gray-400 text-sm font-medium">Data Sources</label>
                <div class="flex flex-wrap gap-2 mt-2">
                  {% for source in rule.data_sources %}
                  <span class="px-2 py-1 bg-green-500/20 text-green-300 rounded-full text-sm">{{ source }}</span>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- Tags -->
          <!-- {% if rule.tags %}
          <div class="bg-gradient-to-br from-purple-500/10 to-pink-600/10 backdrop-blur-sm rounded-xl border border-purple-500/20 overflow-hidden">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-4">
              <h3 class="text-white font-bold text-lg flex items-center">
                <i class="fas fa-tags mr-3"></i>Tags
              </h3>
            </div>
            <div class="p-6">
              <div class="flex flex-wrap gap-2">
                {% for tag in rule.tags %}
                <span class="px-3 py-1 bg-purple-500/20 text-purple-300 rounded-full text-sm hover:bg-purple-500/30 transition-colors duration-300">{{ tag }}</span>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endif %} -->

          <!-- Recent Matches -->
          {% if recent_matches %}
          <div class="bg-gradient-to-br from-orange-500/10 to-red-600/10 backdrop-blur-sm rounded-xl border border-orange-500/20 overflow-hidden">
            <div class="bg-gradient-to-r from-orange-600 to-red-600 p-4">
              <h3 class="text-white font-bold text-lg flex items-center">
                <i class="fas fa-bullseye mr-3"></i>Recent Matches
              </h3>
            </div>
            <div class="p-6 space-y-3">
              {% for match in recent_matches %}
              <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-white font-semibold">{{ match.computer }}</span>
                  <a href="{{ url_for('sigmarules.event_view', log_type=match.log_type, log_id=match.log_id) }}" 
                     class="px-2 py-1 bg-orange-500/30 hover:bg-orange-500/50 text-orange-200 rounded text-sm transition-colors duration-300">
                    <i class="fas fa-eye mr-1"></i>View
                  </a>
                </div>
                <div class="text-gray-400 text-sm">
                  <div>{{ match.user }} | Event {{ match.event_id }}</div>
                  <div>{{ match.time_created }}</div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Rule Statistics -->
          <div class="bg-gradient-to-br from-slate-500/10 to-gray-600/10 backdrop-blur-sm rounded-xl border border-slate-500/20 overflow-hidden">
            <div class="bg-gradient-to-r from-slate-600 to-gray-700 p-4">
              <h3 class="text-white font-bold text-lg flex items-center">
                <i class="fas fa-chart-bar mr-3"></i>Statistics
              </h3>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-2 gap-4 text-center">
                <div>
                  <div class="text-2xl font-bold text-blue-400">{{ rule.stats.total_fields }}</div>
                  <div class="text-gray-400 text-xs">Detection Fields</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-yellow-400">{{ rule.stats.condition_complexity }}</div>
                  <div class="text-gray-400 text-xs">Condition Words</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-green-400">{{ rule.stats.reference_count }}</div>
                  <div class="text-gray-400 text-xs">References</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-red-400">{{ rule.stats.false_positive_count }}</div>
                  <div class="text-gray-400 text-xs">False Positives</div>
                </div>
              </div>
              
              {% if rule.stats.has_filters %}
              <div class="mt-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                <div class="flex items-center text-blue-300 text-sm">
                  <i class="fas fa-filter mr-2"></i>
                  This rule includes filters
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- Enhanced Rule Information Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          
          <!-- Performance Impact -->
          <div class="bg-gradient-to-br from-yellow-500/10 to-orange-600/10 backdrop-blur-sm rounded-xl border border-yellow-500/20 overflow-hidden">
            <div class="bg-gradient-to-r from-yellow-600 to-orange-600 p-4">
              <h3 class="text-white font-bold text-lg flex items-center">
                <i class="fas fa-tachometer-alt mr-3"></i>Performance Impact
              </h3>
            </div>
            <div class="p-6">
              {% if rule.estimated_performance %}
              <div class="space-y-4">
                <div class="flex items-center justify-between">
                  <span class="text-yellow-300 font-medium">Performance Score:</span>
                  <div class="flex items-center">
                    <div class="w-20 bg-gray-700 rounded-full h-2 mr-3">
                      <div class="bg-gradient-to-r from-yellow-400 to-orange-500 h-2 rounded-full" 
                           style="width: {{ rule.estimated_performance.score }}%"></div>
                    </div>
                    <span class="text-white text-sm">{{ rule.estimated_performance.score }}/100</span>
                  </div>
                </div>
                
                <div class="flex items-center justify-between">
                  <span class="text-yellow-300 font-medium">Impact Level:</span>
                  <span class="px-3 py-1 rounded-full text-xs font-semibold
                    {% if rule.estimated_performance.impact_level == 'Low' %}bg-green-600 text-green-100
                    {% elif rule.estimated_performance.impact_level == 'Medium' %}bg-yellow-600 text-yellow-100
                    {% else %}bg-red-600 text-red-100{% endif %}">
                    {{ rule.estimated_performance.impact_level }}
                  </span>
                </div>
                
                {% if rule.estimated_performance.factors %}
                <div>
                  <span class="text-yellow-300 font-medium text-sm">Performance Factors:</span>
                  <ul class="mt-2 space-y-1">
                    {% for factor in rule.estimated_performance.factors %}
                    <li class="text-white text-xs flex items-center">
                      <i class="fas fa-dot-circle mr-2 text-yellow-400"></i>{{ factor }}
                    </li>
                    {% endfor %}
                  </ul>
                </div>
                {% endif %}
              </div>
              {% else %}
              <p class="text-gray-400 text-sm">Performance analysis not available</p>
              {% endif %}
            </div>
          </div>
          
          <!-- Platform Coverage -->
          <div class="bg-gradient-to-br from-emerald-500/10 to-teal-600/10 backdrop-blur-sm rounded-xl border border-emerald-500/20 overflow-hidden">
            <div class="bg-gradient-to-r from-emerald-600 to-teal-600 p-4">
              <h3 class="text-white font-bold text-lg flex items-center">
                <i class="fas fa-server mr-3"></i>Platform Coverage
              </h3>
            </div>
            <div class="p-6">
              {% if rule.platforms and rule.platforms|length > 0 %}
              <div class="flex flex-wrap gap-2 mb-4">
                {% for platform in rule.platforms %}
                <span class="px-3 py-1 bg-emerald-600/30 text-emerald-200 rounded-full text-sm font-medium">
                  <i class="fas fa-{{ 'windows' if platform|lower == 'windows' else 'linux' if platform|lower == 'linux' else 'apple' if platform|lower == 'macos' else 'server' }} mr-1"></i>
                  {{ platform }}
                </span>
                {% endfor %}
              </div>
              {% endif %}
              
              {% if rule.data_sources and rule.data_sources|length > 0 %}
              <div>
                <span class="text-emerald-300 font-medium text-sm">Data Sources:</span>
                <div class="mt-2 flex flex-wrap gap-2">
                  {% for source in rule.data_sources %}
                  <span class="px-2 py-1 bg-emerald-500/20 text-emerald-100 rounded text-xs">{{ source }}</span>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
              
              {% if not rule.platforms and not rule.data_sources %}
              <div class="text-center py-4">
                <i class="fas fa-globe text-emerald-400 text-3xl mb-2"></i>
                <p class="text-emerald-300 text-sm">Platform agnostic</p>
                <p class="text-emerald-400 text-xs">Works across different platforms</p>
              </div>
              {% endif %}
            </div>
          </div>
          
        </div>
        
        <!-- Deployment Considerations -->
        {% if rule.deployment_considerations %}
        <div class="bg-gradient-to-br from-teal-500/10 to-cyan-600/10 backdrop-blur-sm rounded-xl border border-teal-500/20 overflow-hidden mb-8">
          <div class="bg-gradient-to-r from-teal-600 to-cyan-600 p-4">
            <h3 class="text-white font-bold text-lg flex items-center">
              <i class="fas fa-cogs mr-3"></i>Deployment Considerations
            </h3>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              {% for consideration in rule.deployment_considerations %}
              <div class="flex items-start bg-teal-500/5 border border-teal-500/20 rounded-lg p-3">
                <i class="fas fa-exclamation-triangle text-teal-400 mr-3 mt-0.5"></i>
                <span class="text-teal-100 text-sm">{{ consideration }}</span>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Rule Dependencies and Similar Rules -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          
          <!-- Rule Dependencies -->
          <div class="bg-gradient-to-br from-pink-500/10 to-rose-600/10 backdrop-blur-sm rounded-xl border border-pink-500/20 overflow-hidden">
            <div class="bg-gradient-to-r from-pink-600 to-rose-600 p-4">
              <h3 class="text-white font-bold text-lg flex items-center">
                <i class="fas fa-sitemap mr-3"></i>Rule Dependencies
              </h3>
            </div>
            <div class="p-6">
              {% if rule.dependencies and rule.dependencies|length > 0 %}
              <div class="space-y-3">
                {% for dep in rule.dependencies %}
                <div class="bg-pink-500/5 border border-pink-500/20 rounded-lg p-3">
                  <div class="flex items-center justify-between">
                    <span class="text-pink-300 text-sm font-medium">{{ dep.type|title }}:</span>
                    <code class="text-pink-100 text-xs bg-pink-900/30 px-2 py-1 rounded">{{ dep.id }}</code>
                  </div>
                  <p class="text-white text-xs mt-1">{{ dep.description }}</p>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="text-center py-8">
                <i class="fas fa-check-circle text-pink-400 text-4xl mb-3"></i>
                <p class="text-pink-300 text-sm">No dependencies found</p>
                <p class="text-pink-400 text-xs">This rule can operate independently</p>
              </div>
              {% endif %}
            </div>
          </div>
          
          <!-- Similar Rules -->
          <div class="bg-gradient-to-br from-violet-500/10 to-purple-600/10 backdrop-blur-sm rounded-xl border border-violet-500/20 overflow-hidden">
            <div class="bg-gradient-to-r from-violet-600 to-purple-600 p-4">
              <h3 class="text-white font-bold text-lg flex items-center">
                <i class="fas fa-code-branch mr-3"></i>Similar Rules
              </h3>
            </div>
            <div class="p-6">
              {% if rule.similar_rules and rule.similar_rules|length > 0 %}
              <div class="space-y-3">
                {% for similar in rule.similar_rules %}
                <div class="bg-violet-500/5 border border-violet-500/20 rounded-lg p-3">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-white text-sm font-medium truncate">{{ similar.title }}</span>
                    <span class="text-violet-300 text-xs">{{ similar.similarity }}% match</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <code class="text-violet-100 text-xs bg-violet-900/30 px-2 py-1 rounded">{{ similar.id }}</code>
                    <div class="flex flex-wrap gap-1">
                      {% for tag in similar.common_tags[:3] %}
                      <span class="text-xs px-1 py-0.5 bg-violet-600/30 text-violet-200 rounded">{{ tag }}</span>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="text-center py-8">
                <i class="fas fa-snowflake text-violet-400 text-4xl mb-3"></i>
                <p class="text-violet-300 text-sm">No similar rules found</p>
                <p class="text-violet-400 text-xs">This rule has unique characteristics</p>
              </div>
              {% endif %}
            </div>
          </div>
          
        </div>
      </div>
    {% else %}
      <div class="bg-gray-500/20 border border-gray-500/50 rounded-xl p-8 backdrop-blur-sm">
        <div class="text-center">
          <i class="fas fa-search text-gray-400 text-6xl mb-4"></i>
          <h2 class="text-gray-200 font-bold text-2xl mb-2">No Rule Found</h2>
          <p class="text-gray-400 mb-4">The requested rule could not be located.</p>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script>
// Skeleton loader and async rule details fetch
document.addEventListener('DOMContentLoaded', function() {
    const ruleId = document.getElementById('rule-id').value || '{{ rule_id }}';
    const skeleton = document.getElementById('rule-details-skeleton');
    const content = document.getElementById('rule-details-content');
    const errorContainer = document.getElementById('error-container');

    // Only fetch if skeleton is visible
    if (skeleton && !content) {
        fetch(`/sigmarules/rule/${ruleId}/data`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                skeleton.classList.add('hidden');
                errorContainer.classList.remove('hidden');
                return;
            }
            // Render rule details dynamically (or reload to server-rendered)
            window.location.reload(); // reload to get server-rendered content
        })
        .catch(err => {
            skeleton.classList.add('hidden');
            errorContainer.classList.remove('hidden');
        });
    }
});

function copyDetectionCode() {
    const codeElement = document.getElementById('detection-code');
    const text = codeElement.textContent;
    navigator.clipboard.writeText(text).then(() => {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
        button.classList.add('bg-green-500/30');
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('bg-green-500/30');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
    });
}
</script>
{% endblock %}
