name: Build & Release Intrudex Client

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v3

      - name: 📦 Set up CMake
        uses: jwlawson/actions-setup-cmake@v1

      - name: 🛠 Show Tool Versions
        run: |
          cmake --version
          gcc --version
          g++ --version

      - name: Install MinGW
        run: choco install mingw -y

      - name: ➕ Add mc.exe to PATH
        run: |
          $mcPath = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter mc.exe | Select-Object -First 1 -ExpandProperty DirectoryName
          if (-not $mcPath) { throw "mc.exe not found in Windows Kits." }
          echo "$mcPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: 🏗️ Build Project with CMake (MinGW)
        run: |
          cmake -S Intrudex-Client -B Intrudex-Client\Build-Files -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build Intrudex-Client\Build-Files -- -j4

      - name: 📦 Zip Final Build Folder
        run: |
          Compress-Archive -Path Intrudex-Client\build\*,README.md,LICENSE -DestinationPath intrudex-client-build.zip
          echo "BUILD_ZIP=intrudex-client-build.zip" >> $env:GITHUB_ENV

      - name: 🔖 Generate Changelog
        id: changelog
        run: |
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          git log -1 --pretty=format:"* %s%n%n  Commit: %h by %an" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: 🏷️ Create Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag v${{ github.run_number }}
          git push origin v${{ github.run_number }}

      - name: 🚀 Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: "Intrudex Client - v${{ github.run_number }}"
          body: |
            ## 🔐 Intrudex Client - v${{ github.run_number }}

            ### 📦 Summary
            - Version: `v${{ github.run_number }}`
            - Commit: `${{ github.sha }}`
            - Build Type: `Release`
            - Built On: `${{ runner.os }}`

            ### 📁 Included in Release
            - `intrudex-client.exe`
            - All required `.dll`, `.pdb`, config files
            - See build zip file for details

            ### ✅ Usage
            1. Extract `intrudex-client-build.zip`
            2. Run `intrudex-client.exe`
            3. Refer to README for config instructions

            ### ⚠️ Known Issues
            - None reported yet. Open issues if any.

            ---
            🧠 *Built and deployed automatically by GitHub Actions.*

      - name: 📤 Upload Zipped Build Folder to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          files: |
            ${{ env.BUILD_ZIP }}
            Intrudex-Client/version.rc
            🧠 *Built and deployed automatically by GitHub Actions.*

      - name: 📤 Upload Zipped Build Folder to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          files: |
            ${{ env.BUILD_ZIP }}
            Intrudex-Client/version.rc
