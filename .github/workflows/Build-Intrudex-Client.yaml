name: Build & Release Intrudex Client

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  setup:
    runs-on: windows-latest
    outputs:
      build_dir: ${{ steps.set_build_dir.outputs.build_dir }}
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ“¦ Set up CMake
        uses: jwlawson/actions-setup-cmake@v1

      - name: Install MinGW
        run: choco install mingw -y

      - name: â• Add mc.exe to PATH
        run: |
          $mcPath = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter mc.exe | Select-Object -First 1 -ExpandProperty DirectoryName
          if (-not $mcPath) { throw "mc.exe not found in Windows Kits." }
          echo "$mcPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Set build directory output
        id: set_build_dir
        run: echo "build_dir=Intrudex-Client\Build-Files" >> $GITHUB_OUTPUT

  build:
    runs-on: windows-latest
    needs: setup
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: Download environment artifact (if needed)
        uses: actions/download-artifact@v3
        with:
          name: environment
          path: .

      - name: ğŸ›  Show Tool Versions
        run: |
          cmake --version
          gcc --version
          g++ --version

      - name: ğŸ—ï¸ Build Project with CMake (MinGW)
        run: |
          cmake -S Intrudex-Client -B ${{ needs.setup.outputs.build_dir }} -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build ${{ needs.setup.outputs.build_dir }} -- -j4

      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-output
          path: |
            ${{ needs.setup.outputs.build_dir }}\*
            README.md
            LICENSE
            Intrudex-Client/version.rc

  package:
    runs-on: windows-latest
    needs: build
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-output
          path: package

      - name: ğŸ“¦ Zip Final Build Folder
        run: |
          Compress-Archive -Path package\* -DestinationPath intrudex-client-build.zip
          echo "BUILD_ZIP=intrudex-client-build.zip" >> $env:GITHUB_ENV

      - name: ğŸ“¦ Upload Zipped Build
        uses: actions/upload-artifact@v3
        with:
          name: zipped-build
          path: intrudex-client-build.zip

  release:
    runs-on: windows-latest
    needs: package
    steps:
      - name: Download zipped build
        uses: actions/download-artifact@v3
        with:
          name: zipped-build
          path: .

      - name: ğŸ”– Generate Changelog
        id: changelog
        run: |
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          git log -1 --pretty=format:"* %s%n%n  Commit: %h by %an" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: ğŸ“œ List Included Files
        id: filelist
        run: |
          powershell -Command "Expand-Archive -Path intrudex-client-build.zip -DestinationPath _release_temp"
          ls _release_temp -Recurse | Select-Object -ExpandProperty FullName > included_files.txt
          echo "INCLUDED_FILES<<EOF" >> $GITHUB_ENV
          cat included_files.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: ğŸš€ Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: "Intrudex Client - v${{ github.run_number }}"
          body: |
            ## ğŸ” Intrudex Client - v${{ github.run_number }}

            ### ğŸ“¦ Summary
            - Version: `${{ github.run_number }}`
            - Commit: `${{ github.sha }}`
            - Branch: `${{ github.ref_name }}`
            - Author: `${{ github.actor }}`
            - Build Type: `Release`
            - Built On: `${{ runner.os }}`
            - Build Date: `${{ github.event.head_commit.timestamp || github.event.head_commit.committer.date || github.event.commits[0].timestamp || github.run_started_at }}`

            ### ğŸ“ Included in Release
            ```
            ${{ env.INCLUDED_FILES }}
            ```

            ### ğŸ”– Changelog
            ${{ env.CHANGELOG }}

            ### âœ… Usage
            1. Extract `intrudex-client-build.zip`
            2. Run `intrudex-client.exe`
            3. Refer to README for config instructions

            ### âš ï¸ Known Issues
            - None reported yet. Open issues if any.

            ---
            ğŸ§  *Built and deployed automatically by GitHub Actions.*

          files: |
            intrudex-client-build.zip
            package/version.rc
